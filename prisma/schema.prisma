//·prisma/schema.prisma
generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

model User {
  id           String    @id @default(cuid())
  email        String    @unique
  createdAt    DateTime  @default(now())
  passwordHash String
  blocks       Block[]
  orders       Order[]
  sessions     Session[]

  // ✅ KompiPay / Stripe Connect (via KompiPay)
  payoutsStatus            PayoutsStatus @default(not_started)
  kompipayAccountId        String?
  stripeConnectedAccountId String?
  payoutsEnabledAt         DateTime?

  @@index([payoutsStatus])
  @@index([kompipayAccountId])
}

model Session {
  id        String   @id @default(cuid())
  tokenHash String   @unique
  expiresAt DateTime
  createdAt DateTime @default(now())
  userId    String
  user      User     @relation(fields: [userId], references: [id], onDelete: Cascade)

  @@index([userId])
  @@index([expiresAt])
}

model Block {
  id           String       @id @default(cuid())
  handle       String       @unique
  title        String
  description  String
  price        Int
  currency     String       @default("GBP")
  status       BlockStatus  @default(draft)
  quantity     Int?
  soldCount    Int          @default(0)
  deliveryType DeliveryType @default(physical)
  ownerId      String
  createdAt    DateTime     @default(now())
  updatedAt    DateTime     @updatedAt

  owner  User         @relation(fields: [ownerId], references: [id], onDelete: Cascade)
  orders Order[]
  media  BlockMedia[]

  @@index([handle])
  @@index([ownerId])
}

model BlockMedia {
  id        String   @id @default(cuid())
  blockId   String
  url       String
  sort      Int      @default(0)
  createdAt DateTime @default(now())

  block Block @relation(fields: [blockId], references: [id], onDelete: Cascade)

  @@index([blockId])
  @@index([sort])
}

model Order {
  id           String      @id @default(cuid())
  status       OrderStatus @default(pending)
  amount       Int
  currency     String
  email        String
  blockId      String
  sellerId     String

  // ✅ KompiPay / Stripe ids (optional, but very useful)
  kompipayPaymentId         String?
  stripePaymentIntentId     String?
  stripeCheckoutSessionId   String?

  shipName     String?
  shipLine1    String?
  shipLine2    String?
  shipCity     String?
  shipPostcode String?
  shipCountry  String?
  fulfilledAt  DateTime?
  createdAt    DateTime    @default(now())
  updatedAt    DateTime    @updatedAt
  block        Block       @relation(fields: [blockId], references: [id], onDelete: Cascade)
  seller       User        @relation(fields: [sellerId], references: [id], onDelete: Cascade)

  @@index([blockId])
  @@index([sellerId])
  @@index([kompipayPaymentId])
  @@index([stripePaymentIntentId])
}

enum DeliveryType {
  physical
  digital
}

enum BlockStatus {
  draft
  active
  sold_out
}

enum OrderStatus {
  pending
  paid
  fulfilled
  cancelled
}

enum PayoutsStatus {
  not_started
  pending
  active
  restricted
}
